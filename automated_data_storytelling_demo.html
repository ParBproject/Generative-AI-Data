<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Automated Data Storytelling Demo</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:40px; background:#f5f6fa;}
    label {font-weight:bold;}
    #visual {display:flex; gap:20px; flex-wrap:wrap; margin-top:20px;}
    #chart {flex:2 1 60%; min-width:300px; height:450px;}
    #summaries {flex:1 1 300px; display:flex; flex-direction:column; gap:20px;}
    #summary, #gptSummary {padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    #gptSummary {min-height:120px; white-space:pre-wrap;}
  </style>
</head>
<body>
  <h1>Automated Data Storytelling Demo</h1>
  <p>Upload a CSV or load the sample dataset to generate narrative summaries beside interactive charts.</p>
  <input type="file" id="fileInput" accept=".csv" />
  <button id="loadSample">Load Sample Dataset</button>
  <input type="password" id="apiKey" placeholder="OpenAI API Key" style="margin-left:10px;"/>
  <button id="refreshGPT">Refresh GPT Summary</button>
  <div style="margin-top:20px;">
    <label for="columnSelect">Numeric column:</label>
    <select id="columnSelect"></select>
  </div>
  <div id="visual">
    <div id="chart"></div>
    <div id="summaries">
      <div id="summary"></div>
      <div id="gptSummary"></div>
    </div>
  </div>

  <script>
    let dataset = [];
    function parseCSV(text) {
      const [header, ...rows] = text.trim().split(/\r?\n/);
      const cols = header.split(',');
      return rows.map(r => {
        const vals = r.split(',');
        const obj = {};
        cols.forEach((c, i) => obj[c] = vals[i]);
        return obj;
      });
    }
    function updateColumns() {
      const select = document.getElementById('columnSelect');
      select.innerHTML = '';
      if (!dataset.length) return;
      const cols = Object.keys(dataset[0]).filter(c => !isNaN(parseFloat(dataset[0][c])));
      cols.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c; select.appendChild(opt);
      });
      if (cols.length) generateStory(cols[0]);
    }
    async function generateStory(column) {
      const values = dataset.map(r => parseFloat(r[column])).filter(v => !isNaN(v));
      if (!values.length) return;
      const mean = values.reduce((a,b)=>a+b,0)/values.length;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const summary = `The average of <strong>${column}</strong> is <strong>${mean.toFixed(2)}</strong> with a range from <strong>${min.toFixed(2)}</strong> to <strong>${max.toFixed(2)}</strong> based on ${values.length} records.`;
      document.getElementById('summary').innerHTML = summary;
      Plotly.newPlot('chart', [{x: values, type:'histogram', marker:{color:'#7c5cff'}}], {margin:{t:30}, xaxis:{title:column}}, {responsive:true});
      await generateGPTSummary(column, mean, min, max, values.length);
    }
    document.getElementById('columnSelect').addEventListener('change', e => generateStory(e.target.value));

    async function generateGPTSummary(column, mean, min, max, count){
      const apiKey = document.getElementById('apiKey').value.trim();
      const target = document.getElementById('gptSummary');
      if(!apiKey){
        target.textContent = 'Enter API key to fetch GPT summary.';
        return;
      }
      target.textContent = 'Generating summary...';
      const prompt = `Provide a short insight about the distribution of ${column} with mean ${mean.toFixed(2)}, min ${min.toFixed(2)}, max ${max.toFixed(2)} from ${count} observations.`;
      try{
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+apiKey
          },
          body:JSON.stringify({
            model:'gpt-3.5-turbo',
            messages:[{role:'user',content:prompt}],
            max_tokens:100
          })
        });
        const data = await res.json();
        target.textContent = data?.choices?.[0]?.message?.content?.trim() || 'No summary generated.';
      }catch(err){
        target.textContent = 'Error generating summary.';
      }
    }
    document.getElementById('refreshGPT').addEventListener('click', ()=>{
      const col = document.getElementById('columnSelect').value;
      if(col) generateStory(col);
    });
    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { dataset = parseCSV(ev.target.result); updateColumns(); };
      reader.readAsText(file);
    });
    document.getElementById('loadSample').addEventListener('click', () => {
      fetch('https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv')
        .then(res => res.text())
        .then(text => { dataset = parseCSV(text); updateColumns(); });
    });
  </script>
</body>
</html>
