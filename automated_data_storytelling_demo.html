<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Automated Data Storytelling Demo</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:40px; background:#f5f6fa;}
    #app {max-width:1200px; margin:auto;}
    .controls {display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;}
    .controls input, .controls select {padding:6px;}
    button {padding:6px 12px; border:none; background:#7c5cff; color:#fff; border-radius:4px; cursor:pointer;}
    button:hover {background:#6645cc;}
    label {font-weight:bold;}
    #preview {margin-top:20px; overflow-x:auto;}
    #preview table {border-collapse:collapse;}
    #preview th, #preview td {border:1px solid #ddd; padding:4px 8px; font-size:12px;}
    #visual {display:flex; gap:20px; flex-wrap:wrap; margin-top:20px;}
    #chart {flex:2 1 60%; min-width:300px; height:450px; background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    #summaries {flex:1 1 300px; display:flex; flex-direction:column; gap:20px;}
    .summary-card {padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    .summary-card h2 {margin-top:0; font-size:1.1em;}
    #gptSummary {min-height:120px; white-space:pre-wrap;}
  </style>
</head>
<body>
  <div id="app">
    <h1>Automated Data Storytelling Demo</h1>
    <p>Upload a CSV or load the sample dataset to generate narrative summaries beside interactive charts.</p>
    <div class="controls">
      <input type="file" id="fileInput" accept=".csv" />
      <button id="loadSample">Load Sample Dataset</button>
      <input type="password" id="apiKey" placeholder="OpenAI API Key" />
      <button id="refreshGPT">Refresh GPT Summary</button>
      <div>
        <label for="columnSelect">Numeric column:</label>
        <select id="columnSelect"></select>
      </div>
    </div>
    <div id="preview"></div>
    <div id="visual">
      <div id="chart"></div>
      <div id="summaries">
        <div class="summary-card">
          <h2>Stats Summary</h2>
          <div id="summary"></div>
        </div>
        <div class="summary-card">
          <h2>GPT Insight</h2>
          <div id="gptSummary"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let dataset = [];
    function parseCSV(text) {
      const [header, ...rows] = text.trim().split(/\r?\n/);
      const cols = header.split(',');
      return rows.map(r => {
        const vals = r.split(',');
        const obj = {};
        cols.forEach((c, i) => obj[c] = vals[i]);
        return obj;
      });
    }
    function showPreview(){
      const preview = document.getElementById('preview');
      if(!dataset.length){ preview.innerHTML=''; return; }
      const cols = Object.keys(dataset[0]);
      let html = '<table><thead><tr>';
      cols.forEach(c=> html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';
      dataset.slice(0,5).forEach(row=>{
        html += '<tr>';
        cols.forEach(c=> html += `<td>${row[c]}</td>`);
        html += '</tr>';
      });
      html += '</tbody></table>';
      preview.innerHTML = html;
    }
    function updateColumns() {
      const select = document.getElementById('columnSelect');
      select.innerHTML = '';
      if (!dataset.length) return;
      const cols = Object.keys(dataset[0]).filter(c => !isNaN(parseFloat(dataset[0][c])));
      cols.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c; select.appendChild(opt);
      });
      if (cols.length) generateStory(cols[0]);
    }
    async function generateStory(column) {
      const values = dataset.map(r => parseFloat(r[column])).filter(v => !isNaN(v));
      if (!values.length) return;
      const mean = values.reduce((a,b)=>a+b,0)/values.length;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const summary = `The average of <strong>${column}</strong> is <strong>${mean.toFixed(2)}</strong> with a range from <strong>${min.toFixed(2)}</strong> to <strong>${max.toFixed(2)}</strong> based on ${values.length} records.`;
      document.getElementById('summary').innerHTML = summary;
      Plotly.newPlot('chart', [{x: values, type:'histogram', marker:{color:'#7c5cff'}}], {margin:{t:30}, xaxis:{title:column}}, {responsive:true});
      await generateGPTSummary(column, mean, min, max, values.length);
    }
    document.getElementById('columnSelect').addEventListener('change', e => generateStory(e.target.value));

    async function generateGPTSummary(column, mean, min, max, count){
      const apiKey = document.getElementById('apiKey').value.trim();
      const target = document.getElementById('gptSummary');
      if(!apiKey){
        target.textContent = 'Enter API key to fetch GPT summary.';
        return;
      }
      target.innerHTML = '<em>Generating summary...</em>';
      const prompt = `Provide a short insight about the distribution of ${column} with mean ${mean.toFixed(2)}, min ${min.toFixed(2)}, max ${max.toFixed(2)} from ${count} observations.`;
      try{
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+apiKey
          },
          body:JSON.stringify({
            model:'gpt-3.5-turbo',
            messages:[{role:'user',content:prompt}],
            max_tokens:100
          })
        });
        const data = await res.json();
        target.textContent = data?.choices?.[0]?.message?.content?.trim() || 'No summary generated.';
      }catch(err){
        target.textContent = 'Error generating summary.';
      }
    }
    document.getElementById('refreshGPT').addEventListener('click', ()=>{
      const col = document.getElementById('columnSelect').value;
      if(col) generateStory(col);
    });
    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
    reader.onload = ev => { dataset = parseCSV(ev.target.result); showPreview(); updateColumns(); };
      reader.readAsText(file);
    });
    document.getElementById('loadSample').addEventListener('click', () => {
      fetch('https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv')
        .then(res => res.text())
      .then(text => { dataset = parseCSV(text); showPreview(); updateColumns(); });
    });
  </script>
</body>
</html>
